<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="css/progressbar.css">
		<link href="css/mui.css" rel="stylesheet" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" id="title">正在播放</h1>
		</header>
		<div class="mui-content">
			<div class="mui-row" style="text-align: center; margin-top: 10px;">
				<img src="" id="cover" style="width: 150px;height: 150px;border-radius: 50%;"/>
			</div>
		<!-- <button type="button" id="sendtoremote" class="mui-btn mui-btn-yellow mui-btn-block">发送</button> -->
			<style>
				#popover {
					width: 200px;
					height: 100px;
				}
			</style>
			<div id="popover" class="mui-popover">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view" id='toy_list'>
						</ul>
					</div>
				</div>
			</div>
			<a href="#popover" id="openPopover" class="mui-btn mui-btn-primary mui-btn-block">发送到玩具</a>

			<audio style="width: 100%"  id="music" src=''></audio>
			<button type="button" class="mui-btn mui-btn-primary" id='pre' >上一首</button>
			<button type="button" class="mui-btn mui-btn-success" id='next'>下一首</button>
<!-- 			<div class="mui-input-row mui-checkbox mui-left">
			  <label>2倍速</label>
			  <input name="checkbox2"  type="checkbox" id='two_speed'>
			</div> -->
<!-- 			<h5>播放速度：</h5> -->
			<div class="mui-input-row mui-input-range" >
				<label>播放速度: <span id='play_speed-val'></span></label>
				<input type="range" min="0.1" max="3" id='play_speed' step='0.1' onchange="getspeedval();">
			</div>
			
		</div>
	</body>
	<script src="js/mui.js"></script>
	<script type="text/javascript">
		mui.init({
			swipeBack:true //启用右滑关闭功能
		})
		//监听input事件，获取range的value值，也可以直接element.value获取该range的值
		var rangeList = document.querySelectorAll('input[type="range"]');
		for(var i=0,len=rangeList.length;i<len;i++){
			rangeList[i].addEventListener('input',function(){
				if(this.id.indexOf('field')>=0){
					document.getElementById(this.id+'-input').value = this.value;
				}else{
					document.getElementById(this.id+'-val').innerHTML = this.value;
				}
			});
		}
	
		// document.getElementById('field-range-input').addEventListener('input',function(){
		// 	document.getElementById('field-range').value = this.value;
		// });
		
		mui('.mui-scroll-wrapper').scroll()
		var Sdata = null;
		var player = null;

		mui.plusReady(function(){
			Sdata = plus.webview.currentWebview();
			two_speed = window.localStorage.getItem('two_speed', "false");
			
			// console.log(two_speed)
			// console.log(JSON.stringify(Sdata))
			
			document.getElementById("title").innerText = "正在播放" + Sdata.title;
			document.getElementById("cover").src = window.serv_image + Sdata.cover_path;
			// document.getElementById("two_speed").checked = two_speed == 'true' ? two_speed: "" ;
			
			player_speed = window.localStorage.getItem('play_speed','1');
			console.log(player_speed)
			if (player_speed>=0.1 && player_speed<=3){

			}else{
				player_speed = 1;
			}
			console.log(player_speed)
			document.getElementById("play_speed").value = player_speed;
			document.getElementById("play_speed-val").innerText = player_speed;
			// audio_str = `http://iscm.f3322.org:5000/fsdownload/webapi/file_download.cgi/${Sdata.audio_path}?dlink=%222fe69c89e5a3b0e4b9a6202d20e58898e68588e6aca3202d20e4b889e4bd93202d20e99d92e99baae6bc94e692ad202d204d34412fe7acace4b889e5ada320e6adbbe7a59ee6b0b8e7949f2f3031332e6d7033%22&_sharing_id=%22pVu1enZed%22`
			// document.getElementById("music").src = audio_str;
			// console.log(Sdata.auto_next)
			if (Sdata.subclass.search('santi') != -1 || Sdata.subclass.search('1000movies') != -1 ){
				document.getElementById("music").src = window.data_server + '/' + Sdata.nickname + '/' + Sdata.audio_path;
				// console.log(document.getElementById("music").src)
			}else{
				document.getElementById("music").src = window.serv_audio + Sdata.audio_path;
			}

			console.log(document.getElementById("music").src)
			mui.post(window.serv + '/toy_list',{
					user_id:window.localStorage.getItem('id')
				},function(data){
					let toy_list=[];
					toy_list = data.data;
					// console.log(JSON.stringify(toy_list[0]))
					for (var i = 0; i < toy_list.length; i++) {
						// console.log(JSON.stringify(toy_list[i]))
						toy=toy_list[i]
						// console.log(JSON.stringify(toy))
						createToyItem(toy)
					}
				},'json'
			);
			

			
			// audio.playbackRate =  two_speed == 'true' ? 2:1
			audio.playbackRate = player_speed;
			audio.play()
			// player.play()
		})
		

		// document.getElementById('sendtoremote').addEventListener('tap',function () {
		// 	var index = plus.webview.getWebviewById("HBuilder")
		// 	mui.fire(index,'send_music',{to_user:"toy123",music:Sdata.audio_path})
		// })
	
	
		
	  const audio = document.getElementById('music')
	  
	  audio.controls = true;
	  audio.onended = function(){
		  auto_next = window.localStorage.getItem('auto_next', false)
		  if(auto_next =="true"){
			page = plus.webview.getWebviewById("santilist.html");
			mui.fire(page,'next',{Sdata})
			// alert('播放下一首')
		  }else{
			alert('播放结束')
		  }
	  }
	  
	  function createToyItem(data)
	  {
		  var li = document.createElement('li')
		  li.id = data['_id']
		  li.className = "mui-table-view-cell";
		  
		  var a = document.createElement('a')
		  a.innerText=data['baby_name']+' '+data['toy_name']
		  
		  a.onclick = function(){
			  
			  // console.log(myappid)
			  // var index = plus.webview.getWebviewById("HBuilder")
			  var myappid = plus.runtime.appid;
			  var index = plus.webview.getWebviewById(myappid)
			  mui.fire(index,'send_music',{to_user:data['_id'],
			  					from_user:window.localStorage.getItem('id'),
			  					music:Sdata.audio_path,
								subclass:Sdata.subclass,
								nickname:Sdata.nickname,
								})
		  }
		  // console.log(a.innerText)
		  li.appendChild(a)
		  
		  document.getElementById("toy_list").appendChild(li)
	  }

	document.getElementById('pre').addEventListener('tap',function () {
		// console.log("aaaa")
			var page = plus.webview.getWebviewById("santilist.html")
			// console.log(page)
			// console.log(JSON.stringify(Sdata))
	        mui.fire(page,'pre',{Sdata})
	})
	
	document.getElementById('next').addEventListener('tap',function () {
		// console.log("aaaa")
			var page = plus.webview.getWebviewById("santilist.html")
			// console.log(page)
			// console.log(JSON.stringify(Sdata))
	        mui.fire(page,'next',{Sdata})
	})

	// document.getElementById('two_speed').addEventListener('tap',function () {
	//         val = window.localStorage.getItem('two_speed');
	// 		// console.log(typeof(val))
	// 		if (val == 'true' ){
	// 			window.localStorage.setItem('two_speed',"false")
	// 			audio.playbackRate = 1
	// 		}else{
	// 			window.localStorage.setItem('two_speed',"true")
	// 			audio.playbackRate = 2
	// 		}
			
	// 		// console.log(window.localStorage.getItem('two_speed'))
	// })
	
	function getspeedval(){
		val = document.getElementById("play_speed").value;
		
		console.log(val)
		
		if (val <= 3 && val >= 0.1){
			window.localStorage.setItem('play_speed', val )
			audio.playbackRate = val
		}
	}
	</script>

</html>
