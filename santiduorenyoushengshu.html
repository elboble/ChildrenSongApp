<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Document</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<link rel="stylesheet" type="text/css" href="css/mui.css"/>
</head>
<header class="mui-bar mui-bar-nav">
	<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	<h1 class="mui-title" id="page_title"></h1>
</header>
<div class="mui-content">
	<div class="mui-input-row mui-checkbox mui-left">
	  <label>自动播放下一集</label>
	  <input name="checkbox1" value="Item 1" type="checkbox" id='auto_next'>
	</div>
<ul class="mui-table-view" id='content_list'>
</ul>	
</div>

<body>
	
	<script src="js/mui.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
	var current_page = 0;
	var content_data = null;
	var auto_next ;
	mui.init({
		
	  pullRefresh : {
		container:"#content_list",//下拉刷新容器标识，querySelector能定位的css选择器均可，比如：id、.class等
		up : {
		  style:'circle',//必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
		  color:'#2BD009', //可选，默认“#2BD009” 下拉刷新控件颜色
		  height:'50px',//可选,默认50px.下拉刷新控件的高度,
		  range:'100px', //可选 默认100px,控件可下拉拖拽的范围
		  offset:'0px', //可选 默认0px,下拉刷新控件的起始位置
		  auto: true,//可选,默认false.首次加载自动上拉刷新一次
		  callback : pullfresh 
		}
	  }
	});
	
	function pullfresh() {
	     //业务逻辑代码，比如通过ajax从服务器获取新数据；
	     //......
	     //注意，加载完新数据后，必须执行如下代码，注意：若为ajax请求，则需将如下代码放置在处理完ajax响应数据之后
	     //没有更多内容了，endPulldown 传入true， 不再执行下拉刷新
		 console.log("pullfresh")
		 
		 mui.post(window.serv+'/content_list_p',{
				subclass:Sdata['subclass'],
				page_size:10,
				limit_start: current_page *10
			},function(data){
				content_data = data.data;
				document.getElementById("page_title").innerText = data.data[0].nickname
				// console.log(JSON.stringify(data.data))
				for (var i = 0; i < data.data.length; i++) {
					document.getElementById('content_list').appendChild(create_item(data.data[i]));
				}
			},'json'
		 );
		 current_page+=1;
	     mui('#content_list').pullRefresh().endPullupToRefresh();
	}
	
	mui.plusReady(function(){
		Sdata = plus.webview.currentWebview();
		auto_next = window.localStorage.getItem('auto_next', false)

		// console.log(JSON.stringify(Sdata))

		// mui.post(window.serv+'/content_list_p',{
		// 		subclass:Sdata['subclass'],
		// 		page_size:10,
		// 		limit_start: current_page *10
		// 	},function(data){
		// 		document.getElementById("page_title").innerText = data.data[0].nickname
		// 		// console.log(JSON.stringify(data.data))
		// 		for (var i = 0; i < data.data.length; i++) {
		// 			document.getElementById('content_list').appendChild(create_item(data.data[i]));
		// 		}
		// 	},'json'
		// );
	})
	
	function create_item(data){
		var li = document.createElement('li');
		li.id = data['_id']
		li.className = "mui-table-view-cell mui-media";
		// console.log(li.id)
		var a = document.createElement('a');
		a.onclick = function(){
			mui.openWindow({
				url:"player.html",
				id:"player.html",
				extras:data
			})
		}
		var img = document.createElement('img');
		img.className = "mui-media-object mui-pull-left";
		img.src = window.serv_image +data['cover_path'];
		// console.log(img.src)
		var div = document.createElement('div');
		div.className = "mui-media-body";
		div.innerText = data['title'];
		var p = document.createElement('p');
		p.className = "mui-ellipsis";
		p.innerText = data['nickname'];
		
		li.appendChild(a);
		a.appendChild(img);
		a.appendChild(div);
		div.appendChild(p);
		
		return li
	}
	
	document.addEventListener('pre',function(data){
		console.log("jjjj")
		console.log(JSON.stringify(data.detail))
		for (var i = 0; i < content_data.length; i++) {
			// console.log(JSON.stringify(content_data[i]))
				
	
			if(data.detail["Sdata"]["audio_path"] == content_data[i]["audio_path"]){
					console.log(content_data[i]["audio_path"])
					if (i==0){
						mui.toast("已是第一首")
						return
					}
					mui.openWindow({
						url:'player.html',
						id:'player.html',
						extras:content_data[i-1],
						createNew:true
						})
			}
		}
	})
	
	document.addEventListener('next',function(data){
		// console.log("jjjj")
		// console.log(JSON.stringify(data.detail))
		for (var i = 0; i < content_data.length; i++) {
			// console.log(JSON.stringify(content_data[i]))
			
			if(data.detail["Sdata"]["audio_path"] == content_data[i]["audio_path"]){
					if (i==content_data.length-1){
						mui.toast("已是最后一首")
						return
					}
					mui.openWindow({
						url:'player.html',
						id:'player.html',
						extras:content_data[i+1],
						createNew:true
						})
			}
		}
	})
	
	document.getElementById('auto_next').addEventListener('tap',function () {
	        val = window.localStorage.getItem('auto_next');
			// console.log(typeof(val))
			if (val == 'true' ){
				window.localStorage.setItem('auto_next',"false")
			}else{
				window.localStorage.setItem('auto_next',"true")
			}
			
			console.log(window.localStorage.getItem('auto_next'))
	})
	</script>
</body>
</html>